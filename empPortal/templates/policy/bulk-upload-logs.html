{% extends 'master.html' %}

{% block title %}
Policy Data
{% endblock %}

{% block content %}
{% load static %}

<body class="hold-transition sidebar-mini">
<div class="wrapper">
  {% include 'navbar.html' %}
  <!-- /.navbar -->

  <!-- Main Sidebar Container -->
   {% include 'sidebar.html' %}

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper white-bg">
    <!-- Content Header (Page header) -->
    <div class="content-header breadcrump-bg">
      <div class="container-fluid ">
        <div class="row py-2">
          <div class="col-sm-12 col-md-6">
            <h2 class="admin-title m-0 pt-2 text-dark">Policy Logs </h2>
            <ul class="breadcrump">
              <li> <a href="#">Dashboard</a> <i class="fas fa-chevron-right"></i></li>
              <li> <a href="#">Post Policies Mgt</a> <i class="fas fa-chevron-right"></i></li>
              <li>Policy Log</li>
            </ul>
          </div>
          <div class="col-md-6">  
            <div class="d-flex align-items-center justify-content-end">
              <div>
                <a href="{% url 'bulk-policy-mgt' %}" class="breadcrump-addbtn mx-1">Add Bulk Policy</a>
                <a href="{% url 'policy-mgt' %}" class="breadcrump-addbtn mx-1">Add Policy</a>
                <a href="{% url 'policy-data' %}" class="breadcrump-addbtn mx-1">View Policy</a>
              </div>
            </div>
          </div>
        </div>
        <div class="row">
                   
          <div class="col-sm-12 col-md-12">
            <div class="card">
              <div class="card-body">
                  <h4 class="card-hding mb-0 pb-2">Processed</h4>
                  <div class="row mt-2">
                    <div class="col-sm-6 col-md-2 mb-2 pr-0">
                      <div class="incall-report incbox">
                        <div class="row">
                          <div class="col-auto">
                            <div class="incall-report-icon notcontcall-bg">
                                <i class="fa-solid fa-file-fragment"></i>
                            </div>
                          </div>
                          <div class="col">
                            <h3 class="inout-call-title">Total Files </h3>
                            <h1 data-status="total" class="call-countnum">
                              {{ total_files }}
                            </h1>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-sm-6 col-md-2 mb-2 pr-0">
                      <div class="incall-report">
                        <div class="row">
                          <div class="col-auto">
                            <div class="incall-report-icon incal-bg">
                                <i class="fa-solid fa-check-double"></i>
                            </div>
                          </div>
                          <div class="col">
                            <h3 class="inout-call-title">Complete </h3>
                            <h1 data-status="6" class="call-countnum">
                              {{ status_counts.6|default:"0" }}
                            </h1>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-sm-6 col-md-2 mb-2 pr-0">
                      <a href="{% url 'duplicate-policies-list' %}">
                        <div class="incall-report">
                          <div class="row">
                            <div class="col-auto">
                              <div class="incall-report-icon tcinc-bg">
                                  <i class="fa-solid fa-copy"></i>
                              </div>
                            </div>
                            <div class="col">
                              <h3 class="inout-call-title">Duplicate </h3>
                              <h1 data-status="7" class="call-countnum">
                                {{ status_counts.7|default:"0" }}
                              </h1>
                            </div>
                          </div>
                        </div>
                      </a>

                    </div>   
                    <div class="col-sm-6 col-md-2 mb-2 pr-0">
                      <a href="{% url 'failed-policies-list' %}">
                        <div class="incall-report">
                          <div class="row">
                            <div class="col-auto">
                              <div class="incall-report-icon missedcal-bg ">
                                  <i class="fa-solid fa-file-circle-exclamation"></i>
                              </div>
                            </div>
                            <div class="col">
                              <h3 class="inout-call-title">Failed </h3>
                              <h1 data-status="failed" class="call-countnum">{{ failed_count|default:"0" }}</h1>
                            </div>
                          </div>
                        </div>  
                      </a>
                    </div>
                    
                  </div>
              </div>
            </div>
          </div>

          <div class="col-sm-12 col-md-12">
            <div class="card">
              <div class="card-body">
                  <h4 class="card-hding mb-0 pb-2">Inprocess</h4>
                  <div class="row mt-2">
                    <div class="col-sm-6 col-md-2 mb-2 pr-0">
                      <div class="incall-report">
                        <div class="row">
                          <div class="col-auto">
                            <div class="incall-report-icon notcontcall-bg">
                                <i class="fa-solid fa-chart-simple"></i>
                            </div>
                          </div>
                          <div class="col">
                            <h3 class="inout-call-title">File Analysed </h3>
                            <h1 data-status="4" class="call-countnum">
                              {{ status_counts.4|default:"0" }}
                            </h1>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="col-sm-6 col-md-2 mb-2 pr-0">
                      <div class="incall-report">
                        <div class="row">
                          <div class="col-auto">
                            <div class="incall-report-icon incal-bg">
                                <i class="fa-solid fa-upload"></i>
                            </div>
                          </div>
                          <div class="col">
                            <h3 class="inout-call-title">File Uploading </h3>
                            <h1 data-status="1" class="call-countnum">
                              {{ status_counts.1|default:"0" }}
                            </h1>
                          </div>
                        </div>
                      </div>
                    </div>   
                    <div class="col-sm-6 col-md-2 mb-2 pr-0">
                      <a href="{% url 'status-file-uploaded-list' %}">
                        <div class="incall-report">
                          <div class="row">
                            <div class="col-auto">
                              <div class="incall-report-icon tcinc-bg ">
                                  <i class="fa-solid fa-file-arrow-up"></i>
                              </div>
                            </div>
                            <div class="col">
                              <h3 class="inout-call-title">File Uploaded </h3>
                              <h1 data-status="2" class="call-countnum">{{ status_counts.2|default:"0" }}</h1>
                            </div>
                          </div>
                        </div>  
                      </a>

                    </div>
                    <div class="col-sm-6 col-md-2 mb-2 pr-0">
                      <div class="incall-report">
                        <div class="row">
                          <div class="col-auto">
                            <div class="incall-report-icon missedcal-bg">
                                <i class="fa-solid fa-file-half-dashed"></i>
                            </div>
                          </div>
                          <div class="col">
                            <h3 class="inout-call-title">File Analysing </h3>
                            <h1 data-status="3" class="call-countnum">
                              {{ status_counts.3|default:"0" }}
                            </h1>
                          </div>
                        </div>
                      </div>
                    </div>   
                    <div class="col-sm-6 col-md-2 mb-2 pr-0">
                      <div class="incall-report">
                        <div class="row">
                          <div class="col-auto">
                            <div class="incall-report-icon tcinc-bg ">
                                <i class="fa-solid fa-file-pen"></i>
                            </div>
                          </div>
                          <div class="col">
                            <h3 class="inout-call-title">Policy Creating </h3>
                            <h1 data-status="5" class="call-countnum">{{ status_counts.5|default:"0" }}</h1>
                          </div>
                        </div>
                      </div>  
                    </div>
                  </div>
              </div>
            </div>
          </div>

          
          
        </div>
      </div>
    </div>
    <!-- /.content-header -->

    <!-- Main content -->
    <div class="content">
      <div class="container-fluid">
        <div class="row">
          <div class="col-sm-12 col-md-12">
            <div class="card box-shadow-none">
              <div class="card-body px-0 pb-0 pt-0">
                <div class="tab-content" id="nav-tabContent">
                    <div class="table-responsive table-ht">
                    <table class="table table-design">
                      <thead class="table-thead-bg-light table-header-fix">
                        <tr>
                          <th>Campaign Name</th>
                          <th>Files Data</th>
                          <th>Date of Upload</th>
                          <th>Uploaded By</th>
                          <th>Status</th>
                          <th>Action</th>
                          <th>Result</th>

                        </tr>
                      </thead>
                      <tbody>
                        {% for log in logs %}
                          <tr>
                            <td>{{ log.camp_name }} </td>
                            <td>
                              Total : {{ log.count_total_files }} <br>
                              PDF : {{ log.count_pdf_files }} <br>
                              Non PDF : {{ log.count_not_pdf }}
                            </td>
                            <td>{{ log.created_date }}</td>
                            
                            <td>
                              {% if log.created_by %}
                                {{ log.created_by.first_name }} {{ log.created_by.last_name }}
                              {% else %}
                                -
                              {% endif %}
                            </td>
                            <td>
                              {% if log.calculated_status == 'complete' %}
                                <span class="badge badge-success">Complete</span>
                              {% elif log.calculated_status == 'zip_uploaded' %}
                                <span class="badge badge-info">Zip Uploaded</span>
                              {% elif log.calculated_status == 'in_progress' %}
                                <span class="badge badge-dark">In Progress</span>
                              {% else %}
                                <span class="badge badge-warning">Pending</span>
                              {% endif %}

                            </td>

                            <td>
                              <div class="action-btns">
                                <a href="{% url 'bulk-policies'  id=log.id %}" class="btn btn-primary btn-xs"><i class="fas fa-eye"></i></a>
                                <a href="{{ log.file_url }}" target="_blank" class="btn btn-success btn-xs"><i class="fa-solid fa-download"></i> </a>
                              </div>  
                            </td>
                            
                            <td>
                              Success : {{ log.success_extracted_counts }} <br>
                              Duplicate : {{ log.duplicate_extracted_counts }}<br>
                              Failed : {{ log.failed_extracted_counts }}
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                    </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- /.content-wrapper -->

<!-- Main Footer -->
{% include 'footer.html' %}

</div>
<!-- ./wrapper -->

{% include 'footer-script.html' %}
</body>

<script>
  function updateBulkUploadStats() {
    fetch("{% url 'bulk-upload-stats-ajax' %}")
      .then(response => response.json())
      .then(data => {
        if (data.error) return;

        document.querySelector('.call-countnum[data-status="total"]').innerText = data.total_files;
        document.querySelector('.call-countnum[data-status="6"]').innerText = data.status_counts["6"];
        document.querySelector('.call-countnum[data-status="7"]').innerText = data.status_counts["7"];
        document.querySelector('.call-countnum[data-status="4"]').innerText = data.status_counts["4"];
        document.querySelector('.call-countnum[data-status="1"]').innerText = data.status_counts["1"];
        document.querySelector('.call-countnum[data-status="2"]').innerText = data.status_counts["2"];
        document.querySelector('.call-countnum[data-status="3"]').innerText = data.status_counts["3"];
        document.querySelector('.call-countnum[data-status="5"]').innerText = data.status_counts["5"];
        document.querySelector('.call-countnum[data-status="failed"]').innerText = data.failed_count;
      })
      .catch(error => console.error('Error fetching bulk upload stats:', error));
  }

  setInterval(updateBulkUploadStats, 10000); // every 10 seconds
  document.addEventListener("DOMContentLoaded", updateBulkUploadStats); // initial call
</script>

{% endblock %}